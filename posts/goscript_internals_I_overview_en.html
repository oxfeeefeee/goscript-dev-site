<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon" href="/favicon.ico"/><meta name="description" content="Goscript offical website"/><meta property="og:image" content="https://og-image.vercel.app/Goscript%20offical%20website.png?theme=light&amp;md=0&amp;fontSize=75px&amp;images=https%3A%2F%2Fassets.vercel.com%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fnextjs-black-logo.svg"/><meta name="og:title" content="Goscript offical website"/><meta name="twitter:card" content="summary_large_image"/><title>Goscript Internals I: Overview</title><meta name="next-head-count" content="8"/><link rel="preload" href="/_next/static/css/96f76011eaa949d6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/96f76011eaa949d6.css" data-n-g=""/><link rel="preload" href="/_next/static/css/e07893e80d526a25.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e07893e80d526a25.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-c85490a6f758d8f5.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-ea86427ef25bef6d.js" defer=""></script><script src="/_next/static/chunks/pages/_app-20c4a81707b11a34.js" defer=""></script><script src="/_next/static/chunks/733-05d542b0b5535850.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-0f90271f7a4d1f3f.js" defer=""></script><script src="/_next/static/N7kfFw9WG3dcKBTtXiyF7/_buildManifest.js" defer=""></script><script src="/_next/static/N7kfFw9WG3dcKBTtXiyF7/_ssgManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="layout_container__fbLkO"><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class="container"><a href="/" class="navbar-brand"> <img src="/images/goscript-logo.jpeg" width="45" height="45" class="utils_borderCircle__s2nTm" alt="goscript logo"/></a><button aria-controls="basic-navbar-nav" type="button" aria-label="Toggle navigation" class="navbar-toggler collapsed"><span class="navbar-toggler-icon"></span></button><div class="navbar-collapse collapse" id="basic-navbar-nav"><div class="me-auto navbar-nav"><a href="/" data-rr-ui-event-key="/" class="nav-link">Home</a><a href="/#blog-section" data-rr-ui-event-key="/#blog-section" class="nav-link">Blog</a><a href="https://github.com/oxfeeefeee/goscript" data-rr-ui-event-key="https://github.com/oxfeeefeee/goscript" class="nav-link">Github</a></div></div></div></nav><main><article><h1 class="utils_headingXl__u25Y2">Goscript Internals I: Overview</h1><div class="utils_lightText__eUzGY"><a href="https://github.com/oxfeeefeee/">oxfeeefeee</a> <a>2022-07-04</a> //<a href="/posts/goscript_internals_I_overview_zh">中文</a></div><div><h2>Introduction</h2>
<p>Goscript is a VM-based Golang implementation written in Rust. Goscript Internals will be a series of articles explaining Goscript's design. The intended audience are any experienced programmers who are interested in how Goscript works--or, more generally--how a compiler/ a scripting language/ a Go implementation works. You don't need to have a background in compilers, Go or Rust but it does help if you do. This first article is a brief introduction of how a typed scripting language works, which may be boring to experts.</p>
<p>Before we dive in, let's make a table of all the sub-projects:</p>
<table>
<thead>
<tr>
<th>Project</th>
<th>Description</th>
<th>Language</th>
<th>Credit</th>
</tr>
</thead>
<tbody>
<tr>
<td>Parser</td>
<td>turns source into AST</td>
<td>Rust</td>
<td>ported from Official Go</td>
</tr>
<tr>
<td>Type Checker</td>
<td>type deduction and more</td>
<td>Rust</td>
<td>ported from Official Go</td>
</tr>
<tr>
<td>Codegen</td>
<td>turns AST into bytecode</td>
<td>Rust</td>
<td>original work</td>
</tr>
<tr>
<td>VM</td>
<td>runs bytecode</td>
<td>Rust</td>
<td>original work</td>
</tr>
<tr>
<td>Engine</td>
<td>wrapper and native library</td>
<td>Rust</td>
<td>original work</td>
</tr>
<tr>
<td>Std</td>
<td>Standard library</td>
<td>Go</td>
<td>adapted from Go</td>
</tr>
</tbody>
</table>
<p>Let's get a big picture of how things work by looking into what happens with this simple program, when Goscript runs it:</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    b <span class="token operator">:=</span> <span class="token number">2</span>
    c <span class="token operator">:=</span> a <span class="token operator">+</span> b
    <span class="token function">assert</span><span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// built-in function </span>
<span class="token punctuation">}</span>
</code></pre></div>
<h3>The parser</h3>
<p>The parser read the source code and turns it into an AST (<a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">Abstract Syntax Tree</a>)</p>
<ul>
<li>A hand-written tokenizer (<a href="https://github.com/oxfeeefeee/goscript/blob/master/parser/src/scanner.rs">scanner.rs</a>) turns the source code to a list of tokens like this:</li>
</ul>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token string">`</span>
<span class="token string">package, main, var, a, EQL, 1, ...</span>
<span class="token string">`</span>
</code></pre></div>
<ul>
<li>A hand-written <a href="https://en.wikipedia.org/wiki/Recursive_descent_parser">recursive descent</a> parser (<a href="https://github.com/oxfeeefeee/goscript/blob/master/parser/src/parser.rs">parser.rs</a>) turns the list of tokens into a tree. This step might look magical, but in fact quite intuitive, it's just a recursive program, that try to build nodes of different types of statements and expressions, by matching the tokens it sees and the tokens it expects. The tree definition can be found here (<a href="https://github.com/oxfeeefeee/goscript/blob/master/parser/src/ast.rs">ast.rs</a>). The AST of the above program would be something like this:
<img src="/images/ast.jpeg" alt="ast"></li>
</ul>
<h3>The type checker</h3>
<p>The main task of the type checker is type deduction, which means figuring out the exact types of variables, structs, functions etc. to provide type information for code generator and to catch more syntax errors. It does so by traversing the AST and enforcing the rules defined in the language specs. You can take a quick look at <a href="https://github.com/oxfeeefeee/goscript/blob/master/types/src/check/expr.rs">expr.rs</a> and <a href="https://github.com/oxfeeefeee/goscript/blob/master/types/src/check/stmt.rs">stmt.rs</a> to get a general idea of how it works.</p>
<p>In the case of the above example, it deduces that the types of <code>a</code>, <code>b</code>, <code>a + b</code> and <code>c</code> are all <code>int</code>, and the type of <code>c == 3</code> is <code>bool</code>. it also checks that <code>assert</code> does accept one and only one <code>bool</code> argument.</p>
<p>The type checker is the most complex part of the whole project, there is an Go official <a href="https://go.googlesource.com/example/+/HEAD/gotypes/go-types.md">document</a> talking about it in detail. In addition to type deduction, it does <a href="https://github.com/oxfeeefeee/goscript/blob/master/types/src/check/resolver.rs">identifier resolution</a>, <a href="https://github.com/oxfeeefeee/goscript/blob/master/types/src/constant.rs">constant evaluation</a>, and the insignificant looking <a href="https://github.com/oxfeeefeee/goscript/blob/master/types/src/check/initorder.rs">init order computation</a>.</p>
<p>The result of a type checking pass is a syntax error free AST, and a very rich database of type info about the AST, which will be used for bytecode generation.</p>
<h3>The code generator</h3>
<p>The code generator traverses the AST again to generate runtime objects containing the bytecode. For the example above, it generates objects that logically look like this:</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token string">`</span>
<span class="token string">- Package Object (main)</span>
<span class="token string">    - Package member variable (a)</span>
<span class="token string">    - Package member function (constructor)</span>
<span class="token string">        - bytecode: </span>
<span class="token string">            // copy constant10 to register0, which is where "a" is</span>
<span class="token string">            DUPLICATE   |0  |-10 </span>
<span class="token string">            RETURN          </span>
<span class="token string">    - Package member variable (main)</span>
<span class="token string">        - bytecode:</span>
<span class="token string">            // copy constant7 to register0, which is where "b" is</span>
<span class="token string">            DUPLICATE       |0  |-7 </span>
<span class="token string">            // load from package8's 0th member, which is "a", to register2 </span>
<span class="token string">            LOAD_PKG        |2  |-8 |0</span>
<span class="token string">            // register1 = register2 + register0</span>
<span class="token string">            ADD             |1  |2  |0</span>
<span class="token string">            // register2 = (register1 == constant9)</span>
<span class="token string">            EQL             |2  |1  |-9</span>
<span class="token string">            // crash if register2 != true</span>
<span class="token string">            ASSERT          |...|2  </span>
<span class="token string">            RETURN </span>
<span class="token string">`</span>         
</code></pre></div>
<p>As you can see, Goscript abandoned the original stack-based VM in favor of a register-based one. Stack-based VM is intuitive to design, but less efficient. With a stack-based VM, the above <code>ADD</code> would probably need three extra instructions -- two "PUSH" and one "POP" -- to do the same job.</p>
<p>In essence, code generator is just a translator, which translates a tree into a one dimension array, so that for the VM, instead of traversing a tree, which is totally doable but would be much less efficient, it only needs to deal with instructions on a virtual tape one by one, plus jumping back and force. The main part of the code is <a href="https://github.com/oxfeeefeee/goscript/blob/master/codegen/src/codegen.rs">codegen.rs</a>.</p>
<h3>The virtual machine</h3>
<p>As stated above, the VM is just a big loop (<a href="https://github.com/oxfeeefeee/goscript/blob/master/vm/src/vm.rs">vm.rs</a>) that processes instructions until they run out. All the instructions can be divided into three categories:</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token string">`</span>
<span class="token string">- The normal ones:</span>
<span class="token string">    ADD, SUB, EQL, LOAD_ARRAY ...</span>
<span class="token string">- The ones lead to jumping:</span>
<span class="token string">    JUMP, JUMP_IF ...</span>
<span class="token string">- The ones lead to jumping between functions:</span>
<span class="token string">    CALL, RETURN</span>
<span class="token string">`</span>
</code></pre></div>
<p>Let's write a slightly more complex program as an example:</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">addN</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token number">69</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">69</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">addN</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    total <span class="token operator">:=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&#x3C;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        total <span class="token operator">+=</span> m
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> total
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">mul</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> m <span class="token operator">*</span> n
<span class="token punctuation">}</span>
</code></pre></div>
<p>Below is the generated code, the instructions are numbered to make it easier to refer to:</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token string">`</span>
<span class="token string">main:</span>
<span class="token string">1    DUPLICATE       |1 |-3 |... |... |...,</span>
<span class="token string">2    DUPLICATE       |2 |-4 |... |... |...,</span>
<span class="token string">3    LOAD_PKG        |3 |-1 |1 |... |...,</span>
<span class="token string">4    CALL            |3 |0 |... |FlagA |...,</span>
<span class="token string">5    DUPLICATE       |5 |-3 |... |... |...,</span>
<span class="token string">6    DUPLICATE       |6 |-4 |... |... |...,</span>
<span class="token string">7    LOAD_PKG        |7 |-1 |2 |... |...,</span>
<span class="token string">8    CALL            |7 |4 |... |FlagA |...,</span>
<span class="token string">9    EQL             |8 |0 |4 |Int |Int,</span>
<span class="token string">10   ASSERT          |... |8 |... |... |...,</span>
<span class="token string">11   RETURN          |... |... |... |FlagA |...,</span>
<span class="token string"></span>
<span class="token string">addN:</span>
<span class="token string">12   DUPLICATE       |3 |-5 |... |... |...,</span>
<span class="token string">13   DUPLICATE       |4 |-5 |... |... |...,</span>
<span class="token string">14   LSS             |5 |4 |2 |Int |...,</span>
<span class="token string">15   JUMP_IF_NOT     |3 |5 |... |... |...,</span>
<span class="token string">16   ADD_ASSIGN      |3 |1 |... |Int |...,</span>
<span class="token string">17   INC             |4 |... |... |Int |...,</span>
<span class="token string">18   JUMP            |-5 |... |... |... |...,</span>
<span class="token string">19   DUPLICATE       |0 |3 |... |... |...,</span>
<span class="token string">20   RETURN          |... |... |... |FlagA |...,</span>
<span class="token string"></span>
<span class="token string">mul:</span>
<span class="token string">21   MUL             |0 |1 |2 |Int |...,</span>
<span class="token string">22   RETURN          |... |... |... |FlagA |...,</span>
<span class="token string">`</span>
</code></pre></div>
<p>This is what happens when the VM execute the code:</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token string">`</span>
<span class="token string">1: Copy 42 to register1 as addN's argument</span>
<span class="token string">2: Copy 69 to register2 as addN's argument</span>
<span class="token string">3: Load "addN" to register3</span>
<span class="token string">4: Call "addN", jump to instructions in "addN"</span>
<span class="token string">12: Initialize "total" as 0</span>
<span class="token string">13: Initialize "i" as 0</span>
<span class="token string">14: Compare register4("i") and register2("n") to see if i &#x3C; n, and put the result in register5</span>
<span class="token string">15: If register5 is not TRUE, jump to 19</span>
<span class="token string">16: total += m</span>
<span class="token string">17: i++</span>
<span class="token string">18: Jump back to 14</span>
<span class="token string">14: ...</span>
<span class="token string">... ...</span>
<span class="token string">14: ...</span>
<span class="token string">15: Jump to 19</span>
<span class="token string">19: Copy register3("total") to register0(return value)</span>
<span class="token string">20: return, jump back to "main"</span>
<span class="token string">5: Copy 42 to register5 as mul's argument</span>
<span class="token string">6: Copy 69 to register6 as mul's argument</span>
<span class="token string">7: Load "mul" to register7</span>
<span class="token string">8: Call "mul", jump to instructions in "mul"</span>
<span class="token string">22: register0(return value) = register1(argument1) * register2(argument2)</span>
<span class="token string">23: return, jump back to "main"</span>
<span class="token string">9:  Compare register0 and register4 to see if they are equal, and put the result in register8</span>
<span class="token string">10: crash if register8 != true</span>
<span class="token string">11: return, jump out of main and exit the program</span>
<span class="token string">`</span>
</code></pre></div>
<h3>Coming up next</h3>
<p>So far, there is almost nothing specifically about Goscript, pretty much the same thing happens in Python, Lua or even Java, though there are a few differences: Python or Lua doesn't have a type checker, and Java has a much more complicated VM.</p>
<p>The next article will be a deep-dive into Goscript's VM, to explain how various of Go features are implemented in a simple VM, which, unlike to other parts of the project, is a relatively original wheel that got invented.</p>
</div></article></main><div class="layout_backToHome__9sjx_"><a href="/">← Back to home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"goscript_internals_I_overview_en","contentHtml":"\u003ch2\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003eGoscript is a VM-based Golang implementation written in Rust. Goscript Internals will be a series of articles explaining Goscript's design. The intended audience are any experienced programmers who are interested in how Goscript works--or, more generally--how a compiler/ a scripting language/ a Go implementation works. You don't need to have a background in compilers, Go or Rust but it does help if you do. This first article is a brief introduction of how a typed scripting language works, which may be boring to experts.\u003c/p\u003e\n\u003cp\u003eBefore we dive in, let's make a table of all the sub-projects:\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eProject\u003c/th\u003e\n\u003cth\u003eDescription\u003c/th\u003e\n\u003cth\u003eLanguage\u003c/th\u003e\n\u003cth\u003eCredit\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003eParser\u003c/td\u003e\n\u003ctd\u003eturns source into AST\u003c/td\u003e\n\u003ctd\u003eRust\u003c/td\u003e\n\u003ctd\u003eported from Official Go\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eType Checker\u003c/td\u003e\n\u003ctd\u003etype deduction and more\u003c/td\u003e\n\u003ctd\u003eRust\u003c/td\u003e\n\u003ctd\u003eported from Official Go\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eCodegen\u003c/td\u003e\n\u003ctd\u003eturns AST into bytecode\u003c/td\u003e\n\u003ctd\u003eRust\u003c/td\u003e\n\u003ctd\u003eoriginal work\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eVM\u003c/td\u003e\n\u003ctd\u003eruns bytecode\u003c/td\u003e\n\u003ctd\u003eRust\u003c/td\u003e\n\u003ctd\u003eoriginal work\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eEngine\u003c/td\u003e\n\u003ctd\u003ewrapper and native library\u003c/td\u003e\n\u003ctd\u003eRust\u003c/td\u003e\n\u003ctd\u003eoriginal work\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eStd\u003c/td\u003e\n\u003ctd\u003eStandard library\u003c/td\u003e\n\u003ctd\u003eGo\u003c/td\u003e\n\u003ctd\u003eadapted from Go\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eLet's get a big picture of how things work by looking into what happens with this simple program, when Goscript runs it:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003epackage\u003c/span\u003e main\n\n\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e a \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003emain\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    b \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\n    c \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e a \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e b\n    \u003cspan class=\"token function\"\u003eassert\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ec \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// built-in function \u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3\u003eThe parser\u003c/h3\u003e\n\u003cp\u003eThe parser read the source code and turns it into an AST (\u003ca href=\"https://en.wikipedia.org/wiki/Abstract_syntax_tree\"\u003eAbstract Syntax Tree\u003c/a\u003e)\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eA hand-written tokenizer (\u003ca href=\"https://github.com/oxfeeefeee/goscript/blob/master/parser/src/scanner.rs\"\u003escanner.rs\u003c/a\u003e) turns the source code to a list of tokens like this:\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token string\"\u003e`\u003c/span\u003e\n\u003cspan class=\"token string\"\u003epackage, main, var, a, EQL, 1, ...\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e`\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003eA hand-written \u003ca href=\"https://en.wikipedia.org/wiki/Recursive_descent_parser\"\u003erecursive descent\u003c/a\u003e parser (\u003ca href=\"https://github.com/oxfeeefeee/goscript/blob/master/parser/src/parser.rs\"\u003eparser.rs\u003c/a\u003e) turns the list of tokens into a tree. This step might look magical, but in fact quite intuitive, it's just a recursive program, that try to build nodes of different types of statements and expressions, by matching the tokens it sees and the tokens it expects. The tree definition can be found here (\u003ca href=\"https://github.com/oxfeeefeee/goscript/blob/master/parser/src/ast.rs\"\u003east.rs\u003c/a\u003e). The AST of the above program would be something like this:\n\u003cimg src=\"/images/ast.jpeg\" alt=\"ast\"\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eThe type checker\u003c/h3\u003e\n\u003cp\u003eThe main task of the type checker is type deduction, which means figuring out the exact types of variables, structs, functions etc. to provide type information for code generator and to catch more syntax errors. It does so by traversing the AST and enforcing the rules defined in the language specs. You can take a quick look at \u003ca href=\"https://github.com/oxfeeefeee/goscript/blob/master/types/src/check/expr.rs\"\u003eexpr.rs\u003c/a\u003e and \u003ca href=\"https://github.com/oxfeeefeee/goscript/blob/master/types/src/check/stmt.rs\"\u003estmt.rs\u003c/a\u003e to get a general idea of how it works.\u003c/p\u003e\n\u003cp\u003eIn the case of the above example, it deduces that the types of \u003ccode\u003ea\u003c/code\u003e, \u003ccode\u003eb\u003c/code\u003e, \u003ccode\u003ea + b\u003c/code\u003e and \u003ccode\u003ec\u003c/code\u003e are all \u003ccode\u003eint\u003c/code\u003e, and the type of \u003ccode\u003ec == 3\u003c/code\u003e is \u003ccode\u003ebool\u003c/code\u003e. it also checks that \u003ccode\u003eassert\u003c/code\u003e does accept one and only one \u003ccode\u003ebool\u003c/code\u003e argument.\u003c/p\u003e\n\u003cp\u003eThe type checker is the most complex part of the whole project, there is an Go official \u003ca href=\"https://go.googlesource.com/example/+/HEAD/gotypes/go-types.md\"\u003edocument\u003c/a\u003e talking about it in detail. In addition to type deduction, it does \u003ca href=\"https://github.com/oxfeeefeee/goscript/blob/master/types/src/check/resolver.rs\"\u003eidentifier resolution\u003c/a\u003e, \u003ca href=\"https://github.com/oxfeeefeee/goscript/blob/master/types/src/constant.rs\"\u003econstant evaluation\u003c/a\u003e, and the insignificant looking \u003ca href=\"https://github.com/oxfeeefeee/goscript/blob/master/types/src/check/initorder.rs\"\u003einit order computation\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eThe result of a type checking pass is a syntax error free AST, and a very rich database of type info about the AST, which will be used for bytecode generation.\u003c/p\u003e\n\u003ch3\u003eThe code generator\u003c/h3\u003e\n\u003cp\u003eThe code generator traverses the AST again to generate runtime objects containing the bytecode. For the example above, it generates objects that logically look like this:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token string\"\u003e`\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e- Package Object (main)\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e    - Package member variable (a)\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e    - Package member function (constructor)\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e        - bytecode: \u003c/span\u003e\n\u003cspan class=\"token string\"\u003e            // copy constant10 to register0, which is where \"a\" is\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e            DUPLICATE   |0  |-10 \u003c/span\u003e\n\u003cspan class=\"token string\"\u003e            RETURN          \u003c/span\u003e\n\u003cspan class=\"token string\"\u003e    - Package member variable (main)\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e        - bytecode:\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e            // copy constant7 to register0, which is where \"b\" is\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e            DUPLICATE       |0  |-7 \u003c/span\u003e\n\u003cspan class=\"token string\"\u003e            // load from package8's 0th member, which is \"a\", to register2 \u003c/span\u003e\n\u003cspan class=\"token string\"\u003e            LOAD_PKG        |2  |-8 |0\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e            // register1 = register2 + register0\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e            ADD             |1  |2  |0\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e            // register2 = (register1 == constant9)\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e            EQL             |2  |1  |-9\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e            // crash if register2 != true\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e            ASSERT          |...|2  \u003c/span\u003e\n\u003cspan class=\"token string\"\u003e            RETURN \u003c/span\u003e\n\u003cspan class=\"token string\"\u003e`\u003c/span\u003e         \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAs you can see, Goscript abandoned the original stack-based VM in favor of a register-based one. Stack-based VM is intuitive to design, but less efficient. With a stack-based VM, the above \u003ccode\u003eADD\u003c/code\u003e would probably need three extra instructions -- two \"PUSH\" and one \"POP\" -- to do the same job.\u003c/p\u003e\n\u003cp\u003eIn essence, code generator is just a translator, which translates a tree into a one dimension array, so that for the VM, instead of traversing a tree, which is totally doable but would be much less efficient, it only needs to deal with instructions on a virtual tape one by one, plus jumping back and force. The main part of the code is \u003ca href=\"https://github.com/oxfeeefeee/goscript/blob/master/codegen/src/codegen.rs\"\u003ecodegen.rs\u003c/a\u003e.\u003c/p\u003e\n\u003ch3\u003eThe virtual machine\u003c/h3\u003e\n\u003cp\u003eAs stated above, the VM is just a big loop (\u003ca href=\"https://github.com/oxfeeefeee/goscript/blob/master/vm/src/vm.rs\"\u003evm.rs\u003c/a\u003e) that processes instructions until they run out. All the instructions can be divided into three categories:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token string\"\u003e`\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e- The normal ones:\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e    ADD, SUB, EQL, LOAD_ARRAY ...\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e- The ones lead to jumping:\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e    JUMP, JUMP_IF ...\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e- The ones lead to jumping between functions:\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e    CALL, RETURN\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e`\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eLet's write a slightly more complex program as an example:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003epackage\u003c/span\u003e main\n\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003emain\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eassert\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eaddN\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e42\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token number\"\u003e69\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token function\"\u003emul\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e42\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e69\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003eaddN\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003em\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e n \u003cspan class=\"token builtin\"\u003eint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token builtin\"\u003eint\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    total \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e n\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        total \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e m\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e total\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003emul\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003em\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e n \u003cspan class=\"token builtin\"\u003eint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token builtin\"\u003eint\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e m \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e n\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eBelow is the generated code, the instructions are numbered to make it easier to refer to:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token string\"\u003e`\u003c/span\u003e\n\u003cspan class=\"token string\"\u003emain:\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e1    DUPLICATE       |1 |-3 |... |... |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e2    DUPLICATE       |2 |-4 |... |... |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e3    LOAD_PKG        |3 |-1 |1 |... |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e4    CALL            |3 |0 |... |FlagA |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e5    DUPLICATE       |5 |-3 |... |... |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e6    DUPLICATE       |6 |-4 |... |... |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e7    LOAD_PKG        |7 |-1 |2 |... |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e8    CALL            |7 |4 |... |FlagA |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e9    EQL             |8 |0 |4 |Int |Int,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e10   ASSERT          |... |8 |... |... |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e11   RETURN          |... |... |... |FlagA |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e\u003c/span\u003e\n\u003cspan class=\"token string\"\u003eaddN:\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e12   DUPLICATE       |3 |-5 |... |... |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e13   DUPLICATE       |4 |-5 |... |... |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e14   LSS             |5 |4 |2 |Int |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e15   JUMP_IF_NOT     |3 |5 |... |... |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e16   ADD_ASSIGN      |3 |1 |... |Int |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e17   INC             |4 |... |... |Int |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e18   JUMP            |-5 |... |... |... |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e19   DUPLICATE       |0 |3 |... |... |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e20   RETURN          |... |... |... |FlagA |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e\u003c/span\u003e\n\u003cspan class=\"token string\"\u003emul:\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e21   MUL             |0 |1 |2 |Int |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e22   RETURN          |... |... |... |FlagA |...,\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e`\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis is what happens when the VM execute the code:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token string\"\u003e`\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e1: Copy 42 to register1 as addN's argument\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e2: Copy 69 to register2 as addN's argument\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e3: Load \"addN\" to register3\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e4: Call \"addN\", jump to instructions in \"addN\"\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e12: Initialize \"total\" as 0\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e13: Initialize \"i\" as 0\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e14: Compare register4(\"i\") and register2(\"n\") to see if i \u0026#x3C; n, and put the result in register5\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e15: If register5 is not TRUE, jump to 19\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e16: total += m\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e17: i++\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e18: Jump back to 14\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e14: ...\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e... ...\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e14: ...\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e15: Jump to 19\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e19: Copy register3(\"total\") to register0(return value)\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e20: return, jump back to \"main\"\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e5: Copy 42 to register5 as mul's argument\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e6: Copy 69 to register6 as mul's argument\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e7: Load \"mul\" to register7\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e8: Call \"mul\", jump to instructions in \"mul\"\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e22: register0(return value) = register1(argument1) * register2(argument2)\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e23: return, jump back to \"main\"\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e9:  Compare register0 and register4 to see if they are equal, and put the result in register8\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e10: crash if register8 != true\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e11: return, jump out of main and exit the program\u003c/span\u003e\n\u003cspan class=\"token string\"\u003e`\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch3\u003eComing up next\u003c/h3\u003e\n\u003cp\u003eSo far, there is almost nothing specifically about Goscript, pretty much the same thing happens in Python, Lua or even Java, though there are a few differences: Python or Lua doesn't have a type checker, and Java has a much more complicated VM.\u003c/p\u003e\n\u003cp\u003eThe next article will be a deep-dive into Goscript's VM, to explain how various of Go features are implemented in a simple VM, which, unlike to other parts of the project, is a relatively original wheel that got invented.\u003c/p\u003e\n","title":"Goscript Internals I: Overview","date":"2022-07-04","translation":"goscript_internals_I_overview_zh","translation_lang":"中文"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"goscript_internals_I_overview_en"},"buildId":"N7kfFw9WG3dcKBTtXiyF7","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>